{
  "id": "powershell.template.v1.1",
  "title": "PowerShell Script Template v1.1",
  "body": "<#\n# AGENT INSTRUCTIONS (GENERALIZED TEMPLATE v1.1)\n# Purpose: Baseline for new reusable PowerShell utility scripts (NOT limited to Azure). Ensures consistency, safety, testability, and clear user experience.\n#\n# MUST COMPLETE BEFORE COMMIT / RELEASE:\n#  - Populate .SYNOPSIS, .DESCRIPTION (1-3 concise sentences each) and >=2 .EXAMPLE blocks (one basic, one advanced / with -WhatIf or -Diagnostics).\n#  - All parameters documented with .PARAMETER entries (no orphan params in code or help).\n#  - Script uses: [CmdletBinding(SupportsShouldProcess = $true)] if it can change system / external state; rely on built-in -WhatIf / -Confirm (do NOT invent custom -whatIf).\n#  - Idempotent behavior where practical: repeated runs do not duplicate work or corrupt state (document any unavoidable exceptions).\n#  - Output: Structured objects via Write-Output / pipeline; minimal Write-Host (user guidance only). No mixing objects and plain strings on same pipeline step.\n#  - Logging: Use write-console helper. Verbose = internal steps. Host = high-level start/finish & warnings. Errors bubble up (throw) and are aggregated once in main().\n#  - Error Handling: Functions throw; only main() catches. Include inner exception chain text. No empty catch{} blocks. Avoid swallowing non-terminating errors silently.\n#  - Parameter Validation: Use Mandatory, ValidateSet/Pattern/Range where applicable. Provide sensible defaults; avoid magic numbers (centralize constants).\n#  - Approved Verbs: Function names use Get/Set/New/Remove/Test/Invoke/etc. No custom / unapproved verbs.\n#  - Versioning: Maintain Version & Changelog in .NOTES. Increment version for any functional or instruction change. Keep newest entry at bottom of changelog list.\n#  - Testing: Provide companion test harness script (scriptName.tests.ps1 or -test harness) covering: happy path, error path, idempotent re-run, -WhatIf / DryRun scenario. Tests must exit non-zero on failure.\n#  - Style: Consistent indentation, case ($PSScriptRoot), single quoting where expansion not needed, avoid aliases (use Get-ChildItem not gci).\n#  - Security: Never log secrets / tokens / passwords. Prefer SecureString / PSCredential for sensitive input. Sanitize objects before ConvertTo-Json if they may contain secrets.\n#  - Performance: Minimize redundant external/service calls (cache list results within run). Batch operations where feasible. Avoid premature optimization; measure first.\n#  - Diagnostics: Optional -Diagnostics switch may emit environment summary (PSVersion, runtime context, key parameter values) without leaking secrets.\n#  - Exit Codes: main() returns 0 success, non-zero on failure. If script is meant for CI usage, explicitly exit (main). Otherwise just calling main is acceptable for interactive use.\n#  - Self-Update (Optional): Pattern: -SelfUpdate compares remote hash or version; prompt unless -Force.\n#  - PSScriptAnalyzer: Run Invoke-ScriptAnalyzer -Severity Warning,Error; resolve or explicitly document suppressions with justification.\n#  - Verification Checklist (internal, may remove in final):\n#     [ ] Help complete  [ ] Examples valid  [ ] Parameters validated  [ ] Idempotent  [ ] Tests added  [ ] Version bumped  [ ] Analyzer clean\n#\n# WHEN EXTENDING:\n#  - Keep main first. Add new functions alphabetically below placeholder section.\n#  - If adding new external dependencies, note them in .NOTES Requires line.\n#  - For breaking changes, add a short MIGRATION NOTE comment near the changelog entry.\n#\n# DO NOT:\n#  - Invent custom progress or color wrappers if write-console already covers need.\n#  - Force strict mode unless required by repo policy (can re-enable project-wide later).\n#  - Store transient credentials in global variables.\n#\n# End Agent Instructions\n.SYNOPSIS\n\n.DESCRIPTION\n\nMicrosoft Privacy Statement: https://privacy.microsoft.com/en-US/privacystatement\n    MIT License\n    Copyright (c) Microsoft Corporation. All rights reserved.\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE\n\n.NOTES\n    File Name  : template.ps1\n    Author     : GitHubCopilot\n    Requires   : <modules>\n    Disclaimer : Provided AS-IS without warranty.\n    Version    : 1.1\n    Changelog  : 1.0 - Initial release\n                 1.1 - Expanded agent instructions (generalized, structured checklist)\n                 1.2 - Define WhatIf\n\n.PARAMETER X\n\n.EXAMPLE\n\n.LINK\n    # TLS NOTE / SUPPRESSION: Explicit TLS1.2 enable kept for legacy Windows PowerShell hosts that default to older protocols.\n    # Modern PowerShell Core already negotiates TLS1.2+ automatically. Remove if unnecessary in target environment.\n    # analyzer-suppress: HardCodedTLS (intentional for backward compatibility)\n    [net.servicePointManager]::Expect100Continue = $true;[net.servicePointManager]::SecurityProtocol = [net.securityProtocolType]::Tls12;\n    invoke-webRequest \"https://raw.githubusercontent.com/jagilber/powershellScripts/master/template.ps1\" -outFile \"$pwd\\template.ps1\";\n    .\\template.ps1 -examples\n#>\n\n#requires -version 6\n[CmdletBinding()]\nparam(\n    [switch]$whatIf\n)\n\n$PSModuleAutoLoadingPreference = 2\n$ErrorActionPreference = 'continue'\n$scriptName = \"$psscriptroot\\$($MyInvocation.MyCommand.Name)\"\n\n# always top function\nfunction main() {\n    if ($examples) {\n        write-host \"get-help $scriptName -examples\"\n        get-help $scriptName -examples\n        return\n    }\n\n    try {\n\n        # main logic here\n        # create sub functions to handle specific / duplicate work\n        # write-console <executable equivalent of command being executed for future copy/paste>\n        # if(!$whatIf) {\n        #   <command being executed>\n        #}\n\n        <#\n        WhatIf Code Example:\n        write-console \"\n        Test-azResourceGroupDeployment -ResourceGroupName $resourceGroup ``\n            -TemplateFile $templateFile ``\n            -Mode $mode ``\n            -TemplateParameterObject $templateParameters ``\n            @additionalParameters\n        \" -ForegroundColor Cyan\n        \n        if(!$whatIf) {\n          $ret = Test-azResourceGroupDeployment -ResourceGroupName $resourceGroup `\n            -TemplateFile $templateFile `\n            -Mode $mode `\n            -TemplateParameterObject $templateParameters `\n            @additionalParameters\n        }\n        #>\n    }\n    catch {\n        # always implement at least the following lines as is in all scripts for troubleshooting\n        write-host \"exception::$($psitem.Exception.Message)`r`n$($psitem.scriptStackTrace)\" -ForegroundColor Red\n        write-verbose \"variables:$((get-variable -scope local).value | convertto-json -WarningAction SilentlyContinue -depth 2)\"\n        return 1\n    }\n    finally {\n        # perform any necessary cleanup\n    }\n}\n\n# alphabetical list of functions\n# function new-functionDefinition([type]$argument,...) {\n    # write-console 'enter new-functionDefinition'\n        \n    # function logic\n\n    # write-console 'exit new-functionDefinition $($result|convertto-json -depth 2)'\n    # return $result\n#}\n\nfunction write-console($message, [consoleColor]$foregroundColor = 'White', [switch]$verbose, [switch]$err, [switch]$warn) {\n    if (!$message) { return }\n    if ($message.gettype().name -ine 'string') {\n        $message = $message | convertto-json -Depth 10\n    }\n\n    if ($verbose) {\n        write-verbose($message)\n    }\n    else {\n        write-host($message) -ForegroundColor $foregroundColor\n    }\n\n    if ($warn) {\n        write-warning($message)\n    }\n    elseif ($err) {\n        write-error($message)\n        throw\n    }\n}\n\nmain",
  "priority": 50,
  "audience": "PowerShell script authors",
  "requirement": "Provide a standardized starting point for new utility scripts ensuring help, logging, error handling, idempotency, versioning, and diagnostics.",
  "categories": [
    "governance",
    "powershell",
    "template"
  ],
  "sourceHash": "9e10256544d78fb8294f5bcb7915adc21763da8d2b85590d3335eab36c8ce585",
  "schemaVersion": "3",
  "createdAt": "2025-09-10T16:04:11.724Z",
  "updatedAt": "2025-09-12T02:40:52.454Z",
  "riskScore": 50,
  "version": "1.0.0",
  "status": "approved",
  "owner": "unowned",
  "priorityTier": "P3",
  "classification": "internal",
  "lastReviewedAt": "2025-09-10T16:04:11.724Z",
  "nextReviewDue": "2025-12-09T16:04:11.724Z",
  "reviewIntervalDays": 90,
  "changeLog": [
    {
      "version": "1.0.0",
      "changedAt": "2025-09-10T16:04:11.724Z",
      "summary": "initial import"
    }
  ],
  "semanticSummary": "PowerShell Script Template v1.1",
  "primaryCategory": "governance"
}
