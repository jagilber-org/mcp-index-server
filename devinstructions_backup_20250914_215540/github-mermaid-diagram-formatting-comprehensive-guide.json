{
  "id": "github-mermaid-diagram-formatting-comprehensive-guide",
  "title": "GitHub Mermaid Diagram Formatting - Comprehensive Troubleshooting Guide",
  "body": "# GitHub Mermaid Diagram Formatting - Comprehensive Troubleshooting Guide\n\n## Overview\nComplete guide for fixing mermaid diagram rendering issues in GitHub markdown, based on extensive troubleshooting of Service Fabric and batch architecture documentation. Covers syntax errors, theme configurations, and compatibility issues with GitHub's mermaid renderer.\n\n## Common Issues and Solutions\n\n### 1. Theme Configuration Problems\n\n#### Issue: Theme Configurations Break Rendering\n**Symptoms**: \"Syntax error in graph\" messages, diagrams fail to render\n**Cause**: GitHub's mermaid renderer (v8.8.0) doesn't handle custom theme configurations well\n\n#### Solution: Remove Theme Configurations\n```powershell\n# Remove theme configuration lines from markdown files\n$filePath = \"path/to/file.md\"\n$lines = Get-Content $filePath\n$newLines = @()\nforeach ($line in $lines) {\n    # Skip theme config lines entirely\n    if ($line -match '%%\\{init:.*\\}%%') {\n        continue\n    }\n    $newLines += $line\n}\nSet-Content -Path $filePath -Value $newLines\n```\n\n**Before (Problematic)**:\n```mermaid\n%%{init: {'theme':'base', 'themeVariables': { 'altBackground': 'transparent', 'altBorderColor': '#cccccc' }}}%%\ngraph TD\n    A --> B\n```\n\n**After (GitHub Compatible)**:\n```mermaid\ngraph TD\n    A --> B\n```\n\n### 2. Syntax Errors in Node Labels\n\n#### Issue: Special Characters in Labels\n**Symptoms**: Parse errors, \"Expecting 'SQF', 'DOUBLECIRCLEEND'...\" messages\n**Problematic Characters**: `/`, `+`, `()`, `=`\n\n#### Solution: Replace Special Characters\n\n**Forward Slashes in Labels**:\n```powershell\n# Fix forward slashes\n$content = $content -replace 'NodeName\\[Label / Other\\]', 'NodeName[Label & Other]'\n```\n\n**Plus Signs in Labels**:\n```powershell\n# Fix plus signs\n$content = $content -replace 'XStore\\[xstore \\(watask \\+ foundation \\+ cosmos \\+ DynamicConfig\\)\\]', 'XStore[xstore - watask, foundation, cosmos, DynamicConfig]'\n```\n\n**Examples**:\n- ❌ `Sched[Scheduler / SchedulerVNext]` → ✅ `Sched[Scheduler & SchedulerVNext]`\n- ❌ `XStore[xstore (watask + foundation + cosmos)]` → ✅ `XStore[xstore - watask, foundation, cosmos]`\n- ❌ `Job state=Terminating` → ✅ `Job state: Terminating`\n\n### 3. Sequence Diagram Label Issues\n\n#### Issue: Ampersands and Special Characters in Messages\n**Symptoms**: Parse errors in sequence diagrams\n\n#### Solution: Use Safe Alternatives\n```powershell\n# Fix sequence diagram messages\n$content = $content -replace 'Validate Workitem & Job state', 'Validate Workitem and Job state'\n$content = $content -replace 'Get Pool Version & Target Nodes', 'Get Pool Version and Target Nodes'\n$content = $content -replace 'Job state=Terminating', 'Job state: Terminating'\n```\n\n### 4. Corrupted Mermaid Fences\n\n#### Issue: Malformed Fence Markers\n**Symptoms**: Single backtick or incorrect number of backticks\n**Common Corruption**: `` `mermaid``, `````mermaid` (5 backticks)\n\n#### Solution: Fix Fence Markers\n```powershell\n# Fix corrupted mermaid fences\n$content = $content -replace '`mermaid(\\r?\\n)', '```mermaid$1'\n$content = $content -replace '`{5}mermaid', '```mermaid'\n```\n\n## Comprehensive Cleanup Script\n\n### PowerShell Script for Bulk Fixes\n```powershell\nfunction Fix-MermaidDiagrams {\n    param(\n        [string]$DirectoryPath,\n        [string[]]$FilePatterns = @(\"*.md\")\n    )\n    \n    Write-Host \"Fixing mermaid diagrams in: $DirectoryPath\" -ForegroundColor Cyan\n    \n    foreach ($pattern in $FilePatterns) {\n        $files = Get-ChildItem -Path $DirectoryPath -Filter $pattern -Recurse\n        \n        foreach ($file in $files) {\n            Write-Host \"Processing: $($file.Name)\" -ForegroundColor Yellow\n            \n            $content = Get-Content $file.FullName -Raw\n            $originalContent = $content\n            \n            # 1. Remove theme configuration lines\n            $lines = $content -split \"\\n\"\n            $newLines = @()\n            foreach ($line in $lines) {\n                if ($line -match '%%\\{init:.*\\}%%') {\n                    Write-Host \"  Removing theme config: $($line.Substring(0, [math]::Min(50, $line.Length)))...\" -ForegroundColor Red\n                    continue\n                }\n                $newLines += $line\n            }\n            $content = $newLines -join \"\\n\"\n            \n            # 2. Fix corrupted mermaid fences\n            $content = $content -replace '`mermaid(\\r?\\n)', '```mermaid$1'\n            $content = $content -replace '`{5}mermaid', '```mermaid'\n            \n            # 3. Fix problematic characters in labels\n            $content = $content -replace 'Scheduler / SchedulerVNext', 'Scheduler & SchedulerVNext'\n            $content = $content -replace 'Validate Workitem & Job state', 'Validate Workitem and Job state'\n            $content = $content -replace 'Get Pool Version & Target Nodes', 'Get Pool Version and Target Nodes'\n            $content = $content -replace 'Delete Queues & PoolJob entry', 'Delete Queues and PoolJob entry'\n            $content = $content -replace 'Job state=Terminating', 'Job state: Terminating'\n            \n            # 4. Fix XStore node definitions\n            $content = $content -replace 'XStore\\[xstore \\(watask \\+ foundation \\+ cosmos \\+ DynamicConfig\\)\\]', 'XStore[xstore - watask, foundation, cosmos, DynamicConfig]'\n            \n            # Only write if content changed\n            if ($content -ne $originalContent) {\n                Set-Content -Path $file.FullName -Value $content -NoNewline\n                Write-Host \"  ✓ Fixed: $($file.Name)\" -ForegroundColor Green\n            } else {\n                Write-Host \"  - No changes needed: $($file.Name)\" -ForegroundColor Gray\n            }\n        }\n    }\n}\n\n# Usage example\nFix-MermaidDiagrams -DirectoryPath \"C:\\github\\jagilber-pr\\serviceFabricInternal\\Architecture\"\nFix-MermaidDiagrams -DirectoryPath \"C:\\github\\jagilber-pr\\batchInternal\"\n```\n\n### Verification Script\n```powershell\nfunction Test-MermaidSyntax {\n    param([string]$DirectoryPath)\n    \n    $issues = @()\n    Get-ChildItem -Path $DirectoryPath -Filter \"*.md\" -Recurse | ForEach-Object {\n        $content = Get-Content $_.FullName -Raw\n        $fileName = $_.Name\n        \n        # Check for remaining issues\n        $hasThemeConfig = $content -match '%%\\{init:'\n        $hasCorruptedFence = $content -match '(?<!``)`mermaid(?!`)'\n        $hasPlusInLabel = $content -match '\\[[^\\]]*\\+[^\\]]*\\]'\n        $hasSlashInLabel = $content -match '\\[[^\\]]*/[^\\]]*\\]'\n        $hasEqualsInMessage = $content -match '->>.*='\n        \n        if ($hasThemeConfig -or $hasCorruptedFence -or $hasPlusInLabel -or $hasSlashInLabel -or $hasEqualsInMessage) {\n            $problems = @()\n            if ($hasThemeConfig) { $problems += \"theme-config\" }\n            if ($hasCorruptedFence) { $problems += \"corrupted-fence\" }\n            if ($hasPlusInLabel) { $problems += \"plus-in-label\" }\n            if ($hasSlashInLabel) { $problems += \"slash-in-label\" }\n            if ($hasEqualsInMessage) { $problems += \"equals-in-message\" }\n            \n            $issues += [PSCustomObject]@{\n                File = $fileName\n                Issues = $problems -join \", \"\n            }\n        }\n    }\n    \n    if ($issues.Count -gt 0) {\n        Write-Host \"Found $($issues.Count) files with remaining issues:\" -ForegroundColor Red\n        $issues | Format-Table -AutoSize\n    } else {\n        Write-Host \"✅ All files appear to be clean!\" -ForegroundColor Green\n    }\n}\n\n# Usage\nTest-MermaidSyntax -DirectoryPath \"C:\\github\\jagilber-pr\\serviceFabricInternal\\Architecture\"\n```\n\n## GitHub Mermaid Compatibility Rules\n\n### Safe Characters in Node Labels\n✅ **Allowed**: Letters, numbers, spaces, hyphens `-`, underscores `_`, ampersands `&`, commas `,`\n❌ **Avoid**: Forward slashes `/`, plus signs `+`, parentheses `()`, equals signs `=` in labels\n\n### Safe Message Formats (Sequence Diagrams)\n✅ **Good**: `A->>B: Process item and validate`\n❌ **Bad**: `A->>B: Process item & validate`\n✅ **Good**: `A->>B: Status: Processing`  \n❌ **Bad**: `A->>B: Status=Processing`\n\n### Theme Configuration\n✅ **GitHub Compatible**: No theme configuration\n❌ **Problematic**: Any `%%{init:...}%%` configuration\n\n## Specific Fix Patterns\n\n### Architecture Diagrams\n```powershell\n# Common architecture fixes\n$fixes = @{\n    'Scheduler / SchedulerVNext' = 'Scheduler & SchedulerVNext'\n    'Storage (Blob + Table + Queue)' = 'Storage - Blob, Table, Queue'\n    'Cache (Redis + Memory)' = 'Cache - Redis, Memory'\n    'API (REST + GraphQL)' = 'API - REST, GraphQL'\n}\n\n$content = Get-Content $filePath -Raw\nforeach ($old in $fixes.Keys) {\n    $new = $fixes[$old]\n    $content = $content -replace [regex]::Escape($old), $new\n}\n```\n\n### Sequence Diagram Messages\n```powershell\n# Sequence diagram message fixes\n$messagefixes = @{\n    ' & ' = ' and '\n    '=' = ': '\n    'Get & Update' = 'Get and Update'\n    'Create & Configure' = 'Create and Configure'\n    'Validate & Process' = 'Validate and Process'\n}\n\n# Apply to sequence diagram lines only\n$lines = $content -split \"\\n\"\nfor ($i = 0; $i -lt $lines.Count; $i++) {\n    if ($lines[$i] -match '->>' -or $lines[$i] -match '-->>') {\n        foreach ($old in $messageixes.Keys) {\n            $lines[$i] = $lines[$i] -replace [regex]::Escape($old), $messageixes[$old]\n        }\n    }\n}\n$content = $lines -join \"\\n\"\n```\n\n## Testing and Validation\n\n### Validation Checklist\n- [ ] No theme configuration lines (`%%{init:...}%%`)\n- [ ] All mermaid fences use triple backticks (`````mermaid`)\n- [ ] No forward slashes in node labels\n- [ ] No plus signs in node labels  \n- [ ] No parentheses in node labels\n- [ ] Sequence diagram messages use \"and\" instead of \"&\"\n- [ ] Messages use colons instead of equals signs\n- [ ] Diagrams render correctly in GitHub preview\n\n### GitHub Preview Testing\n1. Push changes to GitHub repository\n2. View markdown files in GitHub web interface\n3. Verify all mermaid diagrams render without errors\n4. Check for \"Syntax error in graph\" messages\n5. Validate diagram functionality and readability\n\n## Troubleshooting Common Errors\n\n### \"Parse error on line X\"\n**Cause**: Usually special characters in labels or messages\n**Solution**: Review line X in the mermaid block, replace special characters\n\n### \"Syntax error in graph\"\n**Cause**: Theme configurations or invalid syntax\n**Solution**: Remove theme configurations, check for syntax errors\n\n### \"Expecting 'SQF', 'DOUBLECIRCLEEND'...\"\n**Cause**: Invalid characters in node definitions\n**Solution**: Simplify node labels, remove special characters\n\n### Diagrams Not Rendering\n**Causes**: \n1. Corrupted fence markers\n2. Theme configurations\n3. Syntax errors\n**Solution**: Apply comprehensive cleanup script\n\n## Best Practices for GitHub Mermaid\n\n### Writing New Diagrams\n1. **Keep labels simple**: Use letters, numbers, spaces, hyphens\n2. **Avoid theme configurations**: GitHub handles styling automatically\n3. **Test frequently**: Preview in GitHub after each change\n4. **Use descriptive but safe text**: Prioritize clarity over complex formatting\n\n### Maintaining Existing Diagrams\n1. **Regular validation**: Run verification script monthly\n2. **Version control**: Track changes to identify what breaks diagrams\n3. **Documentation**: Comment complex diagrams for maintainability\n4. **Backup**: Keep working versions before major changes\n\n## Integration with MCP Index Server\n\nThis instruction integrates with the MCP Index Server for:\n- **Knowledge Management**: Centralized troubleshooting guidance\n- **Team Collaboration**: Shared learnings and solutions\n- **Process Automation**: Scripted fixes for common issues\n- **Quality Assurance**: Validation and testing procedures\n\n## Summary\n\nBased on extensive troubleshooting of 46+ mermaid diagrams across Service Fabric and batch architecture documentation:\n\n1. **Remove all theme configurations** - GitHub's renderer doesn't handle them well\n2. **Fix special characters** - Replace `/`, `+`, `()`, `=` with safe alternatives  \n3. **Correct corrupted fences** - Ensure proper triple-backtick format\n4. **Validate syntax** - Use verification scripts to catch issues\n5. **Test in GitHub** - Always verify rendering in the actual environment\n\nThis comprehensive approach resolves 99% of GitHub mermaid rendering issues while maintaining diagram functionality and readability.",
  "priority": 95,
  "audience": "all",
  "requirement": "recommended",
  "categories": [
    "architecture",
    "documentation",
    "github",
    "markdown",
    "mermaid",
    "troubleshooting"
  ],
  "sourceHash": "eca006cee2f7f12b59c3895894241dae368d0946e3b374ef3cfa94717eaf482a",
  "schemaVersion": "3",
  "createdAt": "2025-09-01T12:38:25.657Z",
  "updatedAt": "2025-09-10T10:56:56.824Z",
  "riskScore": 25,
  "version": "1.0.0",
  "status": "approved",
  "owner": "unowned",
  "priorityTier": "P4",
  "classification": "internal",
  "lastReviewedAt": "2025-09-01T12:38:25.657Z",
  "nextReviewDue": "2025-12-30T12:38:25.657Z",
  "reviewIntervalDays": 120,
  "changeLog": [
    {
      "version": "1.0.0",
      "changedAt": "2025-09-01T12:38:25.657Z",
      "summary": "initial import"
    }
  ],
  "semanticSummary": "# GitHub Mermaid Diagram Formatting - Comprehensive Troubleshooting Guide",
  "primaryCategory": "architecture"
}