{
  "id": "mermaid-troubleshooting-implementation-patterns",
  "title": "Mermaid Troubleshooting & Implementation Patterns - Production-Ready Solutions",
  "body": "# Mermaid Troubleshooting & Implementation Patterns - Production-Ready Solutions\n\n## Overview\nPractical troubleshooting guide for mermaid diagram generation issues, implementation patterns, and production deployment strategies based on real-world problem resolution.\n\n## Common Configuration Issues\n\n### MCP Server Discovery Problems\n\n#### Package Name Confusion\n```bash\n# ❌ Common mistakes\nnpm install @modelcontextprotocol/server-mermaid  # Package doesn't exist\nnpx mermaid-server                               # Wrong executable name\n\n# ✅ Correct packages\nnpm install -g mcp-mermaid                       # Basic server\nnpm install -g @falldownthesystem/mcp-mermaid    # Enhanced server\n```\n\n#### Package Verification Workflow\n```bash\n# 1. Search npm registry\nnpm search mcp-mermaid\n\n# 2. Verify package information\nnpm info mcp-mermaid\nnpm info @falldownthesystem/mcp-mermaid\n\n# 3. Test installation\nnpx mcp-mermaid --help\nnpx @falldownthesystem/mcp-mermaid --version\n\n# 4. Check global installations\nnpm list -g | grep mermaid\n```\n\n### VS Code MCP Configuration Issues\n\n#### Environment Variable Problems\n```json\n// ❌ Common environment variable errors\n{\n  \"env\": {\n    \"MERMAID_MAX_INPUT_CHARS\": 15000,     // Should be string\n    \"MERMAID_ENABLE_PNG\": true,          // Should be \"1\"\n    \"MERMAID_DEFAULT_FORMAT\": \"PNG\"      // Case-sensitive, should be \"png\"\n  }\n}\n\n// ✅ Correct environment configuration\n{\n  \"env\": {\n    \"MERMAID_MAX_INPUT_CHARS\": \"15000\",   // String value\n    \"MERMAID_ENABLE_PNG\": \"1\",           // String \"1\" for true\n    \"MERMAID_DEFAULT_FORMAT\": \"svg\"      // Lowercase format names\n  }\n}\n```\n\n#### Server Registration Issues\n```json\n// ❌ Duplicate server names cause conflicts\n{\n  \"mcpServers\": {\n    \"mermaid\": {\n      \"command\": \"npx\",\n      \"args\": [\"mcp-mermaid\"]\n    },\n    \"mermaid\": {  // Duplicate name overwrites previous\n      \"command\": \"npx\",\n      \"args\": [\"@falldownthesystem/mcp-mermaid\"]\n    }\n  }\n}\n\n// ✅ Unique server names\n{\n  \"mcpServers\": {\n    \"Mermaid Basic\": {\n      \"command\": \"npx\",\n      \"args\": [\"mcp-mermaid@latest\"]\n    },\n    \"Mermaid Enhanced\": {\n      \"command\": \"npx\",\n      \"args\": [\"@falldownthesystem/mcp-mermaid@latest\"]\n    }\n  }\n}\n```\n\n### Tool Availability Diagnostics\n\n#### MCP Tool Discovery\n```javascript\n// Check available MCP tools\n// In VS Code: Ctrl+Shift+P -> \"MCP: List Tools\"\n\n// Expected tools for basic server:\n// - mcp_mermaid_diagr_generate_mermaid_diagram\n\n// Expected tools for enhanced server:\n// - mcp_mermaid_enhan_generate_mermaid_diagram\n```\n\n#### VS Code Developer Console Debugging\n```javascript\n// 1. Open Developer Tools: Help > Toggle Developer Tools\n// 2. Look for MCP server logs in Console tab\n// 3. Common error patterns:\n\n// Server not found:\n// \"Failed to start MCP server: Command 'npx mcp-mermaid' not found\"\n\n// Package missing:\n// \"npm ERR! could not determine executable to run\"\n\n// Environment issues:\n// \"Invalid environment variable: MERMAID_MAX_INPUT_CHARS\"\n```\n\n## Styling and Rendering Issues\n\n### Color Visibility Problems\n\n#### High-Contrast Solution Patterns\n```mermaid\n%% ❌ Problem: Poor color contrast\ngraph TD\n    A[Light Yellow Text] --> B[Dark Blue Background]\n    style A fill:#ffffe0,color:#ffffff,stroke:#cccccc  %% White text on light yellow\n    style B fill:#000080,color:#000000,stroke:#000080  %% Black text on dark blue\n\n%% ✅ Solution: High contrast combinations\ngraph TD\n    C[Clear Text] --> D[Readable Text]\n    style C fill:#ffffe0,color:#000000,stroke:#000000,stroke-width:2px  %% Black on light yellow\n    style D fill:#000080,color:#ffffff,stroke:#ffffff,stroke-width:2px  %% White on dark blue\n```\n\n#### Contrast Validation Checklist\n- ✅ Dark text (#000000) on light backgrounds (#ffffff, #f0f0f0, light colors)\n- ✅ Light text (#ffffff) on dark backgrounds (#000000, #333333, dark colors)\n- ❌ Avoid: Light text on light backgrounds\n- ❌ Avoid: Dark text on dark backgrounds\n- ✅ Always include stroke color matching text color for definition\n\n### Font and Typography Issues\n\n#### Font Size Problems\n```mermaid\n%% ❌ Problem: Missing px unit\ngraph TD\n    A[Text Node]\n    style A font-size:16  %% Missing 'px' unit\n\n%% ✅ Solution: Include px unit\ngraph TD\n    B[Text Node]\n    style B font-size:16px,font-weight:bold\n```\n\n#### Typography Best Practices\n```mermaid\ngraph TD\n    A[Title] --> B[Subtitle]\n    B --> C[Body Text]\n    C --> D[Caption]\n    \n    %% Hierarchical typography\n    style A font-size:24px,font-weight:bold,fill:#1e3a8a,color:#ffffff\n    style B font-size:20px,font-weight:bold,fill:#3b82f6,color:#ffffff\n    style C font-size:16px,fill:#93c5fd,color:#000000\n    style D font-size:14px,fill:#dbeafe,color:#000000\n```\n\n### Theme Variable Conflicts\n\n#### Theme Override Issues\n```mermaid\n%%{init: {'theme':'dark', 'themeVariables': {'primaryColor': '#ff0000'}}}%%\ngraph TD\n    A[Node] --> B[Node]\n    %% Individual styles override theme variables\n    style A fill:#00ff00  %% This overrides primaryColor theme variable\n```\n\n#### Resolution Strategy\n1. Use theme variables for global consistency\n2. Use individual styles for specific overrides\n3. Test with base theme to isolate variable effects\n4. Document theme customizations for team consistency\n\n## Performance and Scaling Issues\n\n### Input Size Limitations\n\n#### Character Limit Management\n```javascript\n// Monitor input size\nfunction validateMermaidInput(mermaidSyntax) {\n  const charCount = mermaidSyntax.length;\n  \n  if (charCount > 15000) {\n    console.warn(`Mermaid input too large: ${charCount} characters. Enhanced server limit: 15,000`);\n    return false;\n  } else if (charCount > 10000) {\n    console.warn(`Input size: ${charCount} characters. Consider using enhanced server for better support.`);\n  }\n  \n  return true;\n}\n\n// Usage pattern\nconst diagram = generateLargeDiagram();\nif (validateMermaidInput(diagram)) {\n  mcp_mermaid_enhan_generate_mermaid_diagram({\n    mermaid: diagram,\n    outputType: \"svg\"\n  });\n}\n```\n\n#### Large Diagram Optimization\n```mermaid\n%% ❌ Problematic: Too many individual style declarations\ngraph TD\n    A[Node1] --> B[Node2]\n    A --> C[Node3]\n    B --> D[Node4]\n    C --> E[Node5]\n    \n    style A fill:#ff0000,color:#ffffff\n    style B fill:#ff0000,color:#ffffff\n    style C fill:#00ff00,color:#000000\n    style D fill:#00ff00,color:#000000\n    style E fill:#0000ff,color:#ffffff\n\n%% ✅ Optimized: Use CSS classes\ngraph TD\n    F[Node1] --> G[Node2]\n    F --> H[Node3]\n    G --> I[Node4]\n    H --> J[Node5]\n    \n    classDef redBox fill:#ff0000,color:#ffffff\n    classDef greenBox fill:#00ff00,color:#000000\n    classDef blueBox fill:#0000ff,color:#ffffff\n    \n    class F,G redBox\n    class H,I greenBox\n    class J blueBox\n```\n\n### Memory and Resource Management\n\n#### Batch Processing Pattern\n```javascript\n// Process multiple diagrams efficiently\nasync function generateDiagramBatch(diagrams) {\n  const results = [];\n  \n  for (const diagram of diagrams) {\n    try {\n      const result = await mcp_mermaid_enhan_generate_mermaid_diagram({\n        mermaid: diagram.syntax,\n        outputType: \"svg\",\n        outputPath: `diagrams/${diagram.name}.svg`,\n        saveOnly: true  // Don't return content, just save file\n      });\n      \n      results.push({ name: diagram.name, status: \"success\", path: result.path });\n      \n      // Brief pause to prevent overwhelming the server\n      await new Promise(resolve => setTimeout(resolve, 100));\n      \n    } catch (error) {\n      results.push({ name: diagram.name, status: \"error\", error: error.message });\n    }\n  }\n  \n  return results;\n}\n```\n\n## Output Format Issues\n\n### SVG vs PNG Selection\n\n#### Format Decision Matrix\n| Use Case | Recommended Format | Rationale |\n|----------|-------------------|----------|\n| Documentation | SVG | Scalable, version control friendly |\n| Presentations | PNG | Fixed resolution, universal support |\n| Web display | SVG | Responsive, crisp at all sizes |\n| Print materials | SVG or high-DPI PNG | Quality preservation |\n| Email attachments | PNG | Better email client support |\n\n#### Format-Specific Configurations\n```javascript\n// SVG configuration (recommended for most uses)\nconst svgConfig = {\n  outputType: \"svg\",\n  backgroundColor: \"white\",  // Ensures printable background\n  theme: \"default\"\n};\n\n// PNG configuration (for presentations)\nconst pngConfig = {\n  outputType: \"png\", \n  backgroundColor: \"white\",\n  theme: \"default\"\n};\n\n// Raw mermaid (for version control)\nconst rawConfig = {\n  outputType: \"mermaid\"  // Returns syntax with styling preserved\n};\n```\n\n### File Output Issues\n\n#### Path Resolution Problems\n```javascript\n// ❌ Common path issues\nmcp_mermaid_enhan_generate_mermaid_diagram({\n  mermaid: diagram,\n  outputPath: \"diagrams/file.svg\"  // Relative path may fail if directory doesn't exist\n});\n\n// ✅ Robust path handling\nconst path = require('path');\nconst fs = require('fs');\n\nconst outputDir = path.join(process.cwd(), 'diagrams');\nif (!fs.existsSync(outputDir)) {\n  fs.mkdirSync(outputDir, { recursive: true });\n}\n\nconst outputPath = path.join(outputDir, 'diagram.svg');\nmcp_mermaid_enhan_generate_mermaid_diagram({\n  mermaid: diagram,\n  outputPath: outputPath,\n  saveOnly: true\n});\n```\n\n## Production Deployment Patterns\n\n### CI/CD Integration\n\n#### GitHub Actions Workflow\n```yaml\nname: Generate Mermaid Diagrams\n\non:\n  push:\n    paths:\n      - 'docs/**/*.md'\n      - 'diagrams/**/*.mermaid'\n\njobs:\n  generate-diagrams:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v3\n      \n      - name: Setup Node.js\n        uses: actions/setup-node@v3\n        with:\n          node-version: '18'\n          \n      - name: Install Mermaid CLI\n        run: npm install -g @mermaid-js/mermaid-cli\n        \n      - name: Generate diagrams\n        run: |\n          find . -name \"*.mermaid\" -exec mmdc -i {} -o {}.svg -b white \\;\n          \n      - name: Commit generated diagrams\n        run: |\n          git config --local user.email \"action@github.com\"\n          git config --local user.name \"GitHub Action\"\n          git add *.svg\n          git diff --staged --quiet || git commit -m \"Auto-generate diagrams\"\n          git push\n```\n\n#### Azure DevOps Pipeline\n```yaml\ntrigger:\n  paths:\n    include:\n      - docs/**\n      - diagrams/**\n\npool:\n  vmImage: 'ubuntu-latest'\n\nsteps:\n- task: NodeTool@0\n  inputs:\n    versionSpec: '18.x'\n  displayName: 'Install Node.js'\n\n- script: |\n    npm install -g @mermaid-js/mermaid-cli\n    npm install -g @falldownthesystem/mcp-mermaid\n  displayName: 'Install Mermaid tools'\n\n- script: |\n    find . -name \"*.mermaid\" | while read file; do\n      mmdc -i \"$file\" -o \"${file%.mermaid}.svg\" -b white -t default\n    done\n  displayName: 'Generate diagrams'\n\n- task: PublishPipelineArtifact@1\n  inputs:\n    targetPath: '$(Pipeline.Workspace)'\n    artifact: 'generated-diagrams'\n```\n\n### Automated Documentation Workflows\n\n#### Documentation Generation Pattern\n```javascript\n// Auto-extract mermaid blocks from markdown and generate diagrams\nfunction processDocumentationFiles(directory) {\n  const glob = require('glob');\n  const fs = require('fs');\n  const path = require('path');\n  \n  const markdownFiles = glob.sync(`${directory}/**/*.md`);\n  \n  markdownFiles.forEach(file => {\n    const content = fs.readFileSync(file, 'utf8');\n    const mermaidBlocks = content.match(/```mermaid([\\s\\S]*?)```/g);\n    \n    if (mermaidBlocks) {\n      mermaidBlocks.forEach((block, index) => {\n        const mermaidSyntax = block.replace(/```mermaid\\n?|```/g, '').trim();\n        const baseName = path.basename(file, '.md');\n        const outputPath = path.join(path.dirname(file), `${baseName}-diagram-${index}.svg`);\n        \n        mcp_mermaid_enhan_generate_mermaid_diagram({\n          mermaid: mermaidSyntax,\n          outputType: \"svg\",\n          outputPath: outputPath,\n          backgroundColor: \"white\",\n          saveOnly: true\n        });\n      });\n    }\n  });\n}\n\n// Usage\nprocessDocumentationFiles('./docs');\n```\n\n### Error Handling and Recovery\n\n#### Resilient Diagram Generation\n```javascript\nfunction generateDiagramWithRetry(mermaidSyntax, options = {}, maxRetries = 3) {\n  return new Promise(async (resolve, reject) => {\n    let lastError;\n    \n    for (let attempt = 1; attempt <= maxRetries; attempt++) {\n      try {\n        const result = await mcp_mermaid_enhan_generate_mermaid_diagram({\n          mermaid: mermaidSyntax,\n          outputType: options.outputType || \"svg\",\n          ...options\n        });\n        \n        resolve(result);\n        return;\n        \n      } catch (error) {\n        lastError = error;\n        console.warn(`Diagram generation attempt ${attempt} failed: ${error.message}`);\n        \n        if (attempt < maxRetries) {\n          // Wait before retry with exponential backoff\n          const delay = Math.pow(2, attempt) * 1000;\n          await new Promise(resolve => setTimeout(resolve, delay));\n        }\n      }\n    }\n    \n    reject(new Error(`Failed to generate diagram after ${maxRetries} attempts. Last error: ${lastError.message}`));\n  });\n}\n\n// Usage with fallback\ntry {\n  const diagram = await generateDiagramWithRetry(complexDiagram, { outputType: \"svg\" });\n} catch (error) {\n  console.error('Diagram generation failed, using fallback text representation');\n  return generateTextDiagram(complexDiagram);  // Fallback to ASCII art or description\n}\n```\n\n### Monitoring and Logging\n\n#### Diagram Generation Metrics\n```javascript\nclass MermaidMetrics {\n  constructor() {\n    this.stats = {\n      generated: 0,\n      failed: 0,\n      averageSize: 0,\n      averageTime: 0\n    };\n  }\n  \n  async generateWithMetrics(mermaidSyntax, options) {\n    const startTime = Date.now();\n    const inputSize = mermaidSyntax.length;\n    \n    try {\n      const result = await mcp_mermaid_enhan_generate_mermaid_diagram({\n        mermaid: mermaidSyntax,\n        ...options\n      });\n      \n      const duration = Date.now() - startTime;\n      this.updateStats(true, inputSize, duration);\n      \n      console.log(`✓ Diagram generated in ${duration}ms (${inputSize} chars)`);\n      return result;\n      \n    } catch (error) {\n      this.updateStats(false, inputSize, 0);\n      console.error(`✗ Diagram failed: ${error.message} (${inputSize} chars)`);\n      throw error;\n    }\n  }\n  \n  updateStats(success, size, time) {\n    if (success) {\n      this.stats.generated++;\n      this.stats.averageSize = (this.stats.averageSize + size) / this.stats.generated;\n      this.stats.averageTime = (this.stats.averageTime + time) / this.stats.generated;\n    } else {\n      this.stats.failed++;\n    }\n  }\n  \n  getReport() {\n    return {\n      totalGenerated: this.stats.generated,\n      totalFailed: this.stats.failed,\n      successRate: (this.stats.generated / (this.stats.generated + this.stats.failed)) * 100,\n      averageInputSize: Math.round(this.stats.averageSize),\n      averageGenerationTime: Math.round(this.stats.averageTime)\n    };\n  }\n}\n\n// Usage\nconst metrics = new MermaidMetrics();\nconst result = await metrics.generateWithMetrics(diagram, { outputType: \"svg\" });\nconsole.log('Performance report:', metrics.getReport());\n```\n\n## Quick Troubleshooting Checklist\n\n### Server Issues\n- [ ] Package installed globally: `npm list -g | grep mermaid`\n- [ ] Correct package name: `mcp-mermaid` or `@falldownthesystem/mcp-mermaid`\n- [ ] Server executable works: `npx mcp-mermaid --help`\n- [ ] VS Code MCP configuration syntax correct\n- [ ] No duplicate server names in configuration\n- [ ] Environment variables are strings, not numbers/booleans\n\n### Styling Issues\n- [ ] Font sizes include `px` unit\n- [ ] Colors use proper contrast (dark text on light, light text on dark)\n- [ ] Hex colors include `#` prefix\n- [ ] Style properties separated by commas\n- [ ] CSS class names are valid (no spaces, special characters)\n\n### Output Issues\n- [ ] Output directory exists or can be created\n- [ ] File paths use forward slashes or proper OS path separators\n- [ ] Output format specified correctly: \"svg\", \"png\", \"mermaid\"\n- [ ] Background color specified for print/display compatibility\n\n### Performance Issues\n- [ ] Input size within limits (10K basic, 15K enhanced)\n- [ ] Complex diagrams use CSS classes instead of individual styles\n- [ ] Batch operations include delays between requests\n- [ ] Error handling and retry logic implemented\n\nThis troubleshooting guide provides practical solutions for the most common mermaid implementation challenges based on real-world problem-solving experience.",
  "rationale": "Practical troubleshooting guide covering common mermaid issues, implementation patterns, and production deployment strategies",
  "priority": 70,
  "audience": "all",
  "requirement": "recommended",
  "categories": [
    "best-practices",
    "debugging",
    "implementation",
    "mermaid",
    "production",
    "troubleshooting"
  ],
  "primaryCategory": "best-practices",
  "sourceHash": "de0495cdf36d67974255580ae5d8bc84e21578fef804638eb9ddb47a88d636c0",
  "schemaVersion": "3",
  "createdAt": "2025-09-14T15:28:59.082Z",
  "updatedAt": "2025-09-14T15:28:59.082Z",
  "riskScore": 50,
  "version": "1.0.0",
  "changeLog": [
    {
      "version": "1.0.0",
      "changedAt": "2025-09-14T15:28:59.082Z",
      "summary": "initial import"
    }
  ],
  "status": "approved",
  "owner": "unowned",
  "priorityTier": "P3",
  "classification": "internal",
  "lastReviewedAt": "2025-09-14T15:28:59.082Z",
  "nextReviewDue": "2025-12-13T15:28:59.082Z",
  "reviewIntervalDays": 90,
  "semanticSummary": "# Mermaid Troubleshooting & Implementation Patterns - Production-Ready Solutions"
}
