#!/usr/bin/env node
// Generate docs/PERFORMANCE.md summarizing latest performance baseline, drift comparison, and trend snapshot.

import fs from 'fs';
import path from 'path';

function findLatestBaseline(){
  const dir = path.join(process.cwd(),'data');
  if(!fs.existsSync(dir)) return null;
  const files = fs.readdirSync(dir).filter(f=> f.startsWith('performance-baseline-') && f.endsWith('.json'));
  if(!files.length) return null;
  files.sort();
  const file = path.join(dir, files[files.length-1]);
  try { return { file, data: JSON.parse(fs.readFileSync(file,'utf8')) }; } catch { return null; }
}

function readIfExists(rel){
  const file = path.join(process.cwd(), rel);
  if(!fs.existsSync(file)) return null;
  try { return { file, data: JSON.parse(fs.readFileSync(file,'utf8')) }; } catch { return null; }
}

function formatTable(samples){
  const header = '| Tool | Count | P50 (ms) | P95 (ms) | Mean (ms) | Max (ms) |\n|------|-------|----------|----------|-----------|---------|';
  const rows = Object.entries(samples).map(([tool, s])=> `| ${tool} | ${s.count} | ${s.p50} | ${s.p95} | ${s.mean} | ${s.max} |`);
  return [header, ...rows].join('\n');
}

function formatMemory(mem){
  if(!mem || !Object.keys(mem).length) return '_No memory samples captured_';
  const header = '| Tool | RSS Min (MB) | RSS Max (MB) | Mean (MB) | Delta (MB) | Samples |';
  const rows = Object.entries(mem).map(([tool, m])=>{
    const mb = v=> (v/1024/1024).toFixed(1);
    return `| ${tool} | ${mb(m.rssMin)} | ${mb(m.rssMax)} | ${mb(m.rssMean)} | ${mb(m.rssDelta)} | ${m.samples} |`;
  });
  return [header, ...rows].join('\n');
}

function formatTrend(trend){
  if(!trend) return '_No trend data_';
  const lines = ['Metric: '+trend.metric, 'Baselines: '+trend.count, ''];
  for(const [tool, pts] of Object.entries(trend.points||{})){
    const short = pts.slice(-5).map(p=> `${p.value}`).join(', ');
    lines.push(`- ${tool}: ${short}${pts.length>5?' â€¦':''}`);
  }
  return lines.join('\n');
}

function main(){
  const latest = findLatestBaseline();
  const drift = readIfExists('data/performance-drift-latest.json');
  const trend = readIfExists('data/performance-trend.json');
  const now = new Date().toISOString();
  const lines = [];
  lines.push('# Performance Overview');
  lines.push('');
  lines.push(`Generated: ${now}`);
  if(latest){
    lines.push('');
    lines.push('## Latest Baseline');
    lines.push('File: `'+latest.file+'`');
    lines.push('Node: '+latest.data.nodeVersion+' Platform: '+latest.data.platform+' Commit: '+latest.data.commit);
    lines.push('');
    lines.push(formatTable(latest.data.samples));
    lines.push('');
    lines.push('### Memory (RSS)');
    lines.push(formatMemory(latest.data.memory));
  } else {
    lines.push('\n_No baseline data available_');
  }
  if(drift){
    lines.push('');
    lines.push('## Drift Comparison');
    lines.push('File: `'+drift.file+'`');
    lines.push('Primary Metric: '+drift.data.primaryMetric+' Threshold: '+drift.data.thresholdPct+'%');
    lines.push('Regressions: '+drift.data.regressions);
  }
  if(trend){
    lines.push('');
    lines.push('## Trend Snapshot');
    lines.push(formatTrend(trend.data));
  }
  lines.push('');
  lines.push('---');
  lines.push('Automated report generated by perf-summary-md.mjs');
  const outFile = path.join(process.cwd(),'docs','PERFORMANCE.md');
  fs.writeFileSync(outFile, lines.join('\n')+'\n');
  console.log('[perf-summary] wrote', outFile);
}

main();
