<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4.1 Admin Panel - MCP Index Server</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .admin-header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .admin-nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .nav-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn.active {
            background: linear-gradient(45deg, #764ba2, #667eea);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .admin-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .admin-card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 500;
            color: #666;
        }

        .stat-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .status-healthy { background: #2ecc71; }
        .status-warning { background: #f39c12; }
        .status-critical { background: #e74c3c; }
    /* Treat failed same visual as critical but distinct semantic label */
    .status-failed { background: #e74c3c; }

        .action-btn {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .action-btn.danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .action-btn.warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .maintenance-status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
        }

        .maintenance-enabled {
            background: #ffe6e6;
            color: #c0392b;
            border: 2px solid #e74c3c;
        }

        .maintenance-disabled {
            background: #e6ffe6;
            color: #27ae60;
            border: 2px solid #2ecc71;
        }

        .config-form {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .form-input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .sessions-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .session-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .session-id {
            font-family: monospace;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ffe6e6;
            color: #c0392b;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e74c3c;
        }

        .success {
            background: #e6ffe6;
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #2ecc71;
        }

        @media (max-width: 768px) {
            .admin-nav {
                flex-direction: column;
                align-items: center;
            }
            
            .admin-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-btn {
                width: 200px;
            }
        }
    .build-meta { margin-top:10px; font-size:0.85rem; color:#444; }
    .build-badge { display:inline-block; background:#222; color:#fff; padding:2px 6px; border-radius:10px; font-size:0.65rem; margin-left:6px; letter-spacing:0.5px; }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>üõ°Ô∏è Phase 4.1 Admin Panel</h1>
            <p>Enterprise Administration Interface for MCP Index Server</p>
            <div id="buildMeta" class="build-meta">Loading build metadata‚Ä¶</div>
            <div class="admin-nav">
                <button class="nav-btn active" onclick="showSection('overview')">üìä Overview</button>
                <button class="nav-btn" onclick="showSection('config')">‚öôÔ∏è Configuration</button>
                <button class="nav-btn" onclick="showSection('sessions')">üë• Sessions</button>
                <button class="nav-btn" onclick="showSection('maintenance')">üîß Maintenance</button>
                <button class="nav-btn" onclick="showSection('monitoring')">üìà Monitoring</button>
                <button class="nav-btn" onclick="showSection('instructions')">üìö Instructions</button>
            </div>
        </div>

        <!-- Overview Section -->
        <div id="overview-section" class="admin-section">
            <div class="admin-grid">
                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-icon">üìä</div>
                        <div class="card-title">System Statistics</div>
                    </div>
                    <div id="system-stats" class="loading">Loading system statistics...</div>
                </div>

                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-icon">üíö</div>
                        <div class="card-title">System Health</div>
                    </div>
                    <div id="system-health" class="loading">Loading system health...</div>
                </div>

                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-icon">‚ö°</div>
                        <div class="card-title">Performance</div>
                    </div>
                    <div id="performance-stats" class="loading">Loading performance data...</div>
                </div>

                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-icon">üìö</div>
                        <div class="card-title">Catalog Status</div>
                    </div>
                    <div id="catalog-stats" class="loading">Loading catalog information...</div>
                </div>
            </div>
        </div>

        <!-- Configuration Section -->
        <div id="config-section" class="admin-section hidden">
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-icon">‚öôÔ∏è</div>
                    <div class="card-title">Server Configuration</div>
                </div>
                <div id="config-form" class="loading">Loading configuration...</div>
            </div>
        </div>

        <!-- Sessions Section -->
        <div id="sessions-section" class="admin-section hidden">
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-icon">üë•</div>
                    <div class="card-title">Active Admin Sessions</div>
                </div>
                <div id="sessions-list" class="loading">Loading sessions...</div>
                <button class="action-btn" onclick="createTestSession()">Create Test Session</button>
            </div>
        </div>

        <!-- Maintenance Section -->
        <div id="maintenance-section" class="admin-section hidden">
            <div class="admin-grid">
                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-icon">üîß</div>
                        <div class="card-title">Maintenance Control</div>
                    </div>
                    <div id="maintenance-control" class="loading">Loading maintenance status...</div>
                </div>

                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-icon">üíæ</div>
                        <div class="card-title">System Operations</div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn" onclick="performBackup()">üíæ Create Backup</button>
                        <button class="action-btn warning" onclick="clearCaches()">üóëÔ∏è Clear Caches</button>
                        <button class="action-btn danger" onclick="restartServer()">üîÑ Restart Server</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring Section -->
        <div id="monitoring-section" class="admin-section hidden">
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-icon">üìà</div>
                    <div class="card-title">Real-time Monitoring</div>
                </div>
                <div id="monitoring-data" class="loading">Loading monitoring data...</div>
            </div>
            <div class="admin-card" style="margin-top:20px;">
                <div class="card-header">
                    <div class="card-icon">üß™</div>
                    <div class="card-title">Synthetic Activity</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                    <div>
                        <label class="form-label" style="font-size:12px;">Iterations</label>
                        <input id="synthetic-iterations" class="form-input" type="number" value="25" style="width:90px;" />
                    </div>
                    <div>
                        <label class="form-label" style="font-size:12px;">Concurrency</label>
                        <input id="synthetic-concurrency" class="form-input" type="number" value="3" style="width:90px;" />
                    </div>
                    <button id="synthetic-run-btn" class="action-btn" onclick="runSyntheticActivity()">Run Synthetic Activity</button>
                    <div id="synthetic-output" style="font-size:12px; opacity:0.85; min-height:20px; line-height:1.3; white-space:pre-wrap;"></div>
                </div>
                <div style="margin-top:8px; font-size:11px; opacity:0.7;">Executes random safe tools to exercise metrics & health. <span id="synthetic-last-meta" style="font-style:italic;"></span></div>
            </div>
        </div>

        <!-- Instruction Management Section -->
        <div id="instructions-section" class="admin-section hidden">
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-icon">üìö</div>
                    <div class="card-title">Instruction Catalog</div>
                </div>
                <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="action-btn" onclick="loadInstructions()">üîÑ Refresh</button>
                    <button class="action-btn" onclick="showCreateInstruction()">‚ûï Create</button>
                    <input id="instruction-filter" placeholder="Filter by name..." class="form-input" style="flex:1; min-width:200px;" oninput="filterInstructions()" />
                </div>
                <div id="instructions-list" class="loading">Loading instructions...</div>
                <div id="instruction-pagination" style="margin-top:12px;"></div>
                <div id="instruction-editor" class="hidden" style="margin-top:20px;">
                    <h3 id="instruction-editor-title" style="margin-bottom:10px;">New Instruction</h3>
                    <div class="form-group">
                        <label class="form-label">File Name (no extension)</label>
                        <input id="instruction-filename" class="form-input" placeholder="example-instruction" />
                    </div>
                    <div class="form-group" style="margin-top:10px;">
                        <label class="form-label">JSON Content</label>
                        <textarea id="instruction-content" class="form-input" style="min-height:200px; font-family:monospace; white-space:pre; overflow:auto;"></textarea>
                    </div>
                    <div style="margin-top:10px;">
                        <button class="action-btn" onclick="saveInstruction()">üíæ Save</button>
                        <button class="action-btn warning" onclick="cancelEditInstruction()">‚úñ Cancel</button>
                    </div>
                </div>
            </div>
            <div class="admin-card" style="margin-top:20px;">
                <div class="card-header">
                    <div class="card-icon">üóÇÔ∏è</div>
                    <div class="card-title">Session History</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
                    <label style="font-size:12px;">Limit
                        <select id="session-history-limit" class="form-input" style="width:80px; padding:4px;" onchange="refreshSessionHistory()">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="250">250</option>
                        </select>
                    </label>
                    <button class="action-btn" onclick="refreshSessionHistory()">üîÑ Refresh History</button>
                </div>
                <div id="session-history-list" class="loading">History not loaded...</div>
            </div>
        </div>
    </div>

    <script>
        // Admin Panel JavaScript
        let currentSection = 'overview';
        let refreshInterval;
    // Track if /api/admin/stats responded successfully on most recent loadOverviewData()
    // Used to downgrade health display (memory/errors) when stats are missing.
    let statsAvailable = false;

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            showSection('overview');
            startAutoRefresh();
        });

        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));

            // Show selected section if present
            const activeSection = document.getElementById(section + '-section');
            if (activeSection) activeSection.classList.remove('hidden');

            // Update nav buttons without relying on implicit event
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isTarget = btn.getAttribute('onclick')?.includes(`showSection('${section}')`);
                if (isTarget) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            currentSection = section;
            loadSectionData(section);
        }

        function loadSectionData(section) {
            switch(section) {
                case 'overview':
                    loadOverviewData();
                    break;
                case 'config':
                    loadConfiguration();
                    break;
                case 'sessions':
                    loadSessions();
                    break;
                case 'maintenance':
                    loadMaintenanceStatus();
                    break;
                case 'monitoring':
                    loadMonitoringData();
                    break;
                case 'instructions':
                    loadInstructions();
                    break;
            }
        }

        async function loadOverviewData() {
            try {
                const [statsRes, maintenanceRes, healthRes] = await Promise.all([
                    fetch('/api/admin/stats').catch(e => e),
                    fetch('/api/admin/maintenance').catch(e => e),
                    fetch('/api/health').catch(e => e)
                ]);

                const [statsData, maintenanceData, healthData] = await Promise.all([
                    statsRes?.json ? statsRes.json().catch(() => ({})) : {},
                    maintenanceRes?.json ? maintenanceRes.json().catch(() => ({})) : {},
                    healthRes?.json ? healthRes.json().catch(() => ({})) : {}
                ]);

                if (statsData?.success && statsData.stats) {
                    statsAvailable = true;
                    displaySystemStats(statsData.stats);
                } else {
                    statsAvailable = false;
                    const statsEl = document.getElementById('system-stats');
                    if (statsEl) statsEl.innerHTML = '<div class="error-message">Stats unavailable</div>';
                }

                // Maintenance summary (safe-guarded: function may be a no-op if not yet implemented)
                if (maintenanceData?.success && maintenanceData.maintenance) {
                    if (typeof displayMaintenanceInfo === 'function') {
                        try { displayMaintenanceInfo(maintenanceData.maintenance); } catch(e) { console.warn('displayMaintenanceInfo failed:', e); }
                    }
                }

                // Accept multiple health status variants: legacy 'ok' plus basic endpoint 'healthy'/'degraded'
                if (healthData && (healthData.success || ['ok','healthy','degraded'].includes(healthData.status))) {
                    displaySystemHealth(healthData.systemHealth || healthData.maintenance?.systemHealth || healthData);
                }
            } catch (error) {
                console.error('Error loading overview data:', error);
                showError('Failed to load overview data');
            }
        }

        function displaySystemStats(stats) {
            const html = `
                <div class="stat-row">
                    <span class="stat-label">Uptime</span>
                    <span class="stat-value">${formatUptime(stats.uptime)}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Active Connections (WS)</span>
                    <span class="stat-value">${stats.activeConnections}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Admin Sessions</span>
                    <span class="stat-value">${stats.adminActiveSessions ?? '0'}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Requests</span>
                    <span class="stat-value">${stats.totalRequests.toLocaleString()}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Error Rate</span>
                    <span class="stat-value">${stats.errorRate.toFixed(2)}%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Response Time</span>
                    <span class="stat-value">${stats.avgResponseTime.toFixed(1)}ms</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Memory Usage</span>
                    <span class="stat-value">${formatBytes(stats.memoryUsage.heapUsed)} / ${formatBytes(stats.memoryUsage.heapTotal)}</span>
                </div>
            `;
            document.getElementById('system-stats').innerHTML = html;

            // Performance stats
            const perfHtml = `
                <div class="stat-row">
                    <span class="stat-label">Total Connections</span>
                    <span class="stat-value">${stats.totalConnections.toLocaleString()}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Error Rate</span>
                    <span class="stat-value">${stats.errorRate.toFixed(2)}%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Response Time</span>
                    <span class="stat-value">${stats.avgResponseTime.toFixed(1)}ms</span>
                </div>
            `;
            document.getElementById('performance-stats').innerHTML = perfHtml;

            // Catalog stats
            const catalogHtml = `
                <div class="stat-row">
                    <span class="stat-label">Total Instructions</span>
                    <span class="stat-value">${stats.catalogStats.totalInstructions}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Version</span>
                    <span class="stat-value">${stats.catalogStats.version}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Last Updated</span>
                    <span class="stat-value">${stats.catalogStats.lastUpdated ? new Date(stats.catalogStats.lastUpdated).toLocaleString() : 'N/A'}</span>
                </div>
            `;
            const catalogEl = document.getElementById('catalog-stats');
            if (catalogEl) catalogEl.innerHTML = catalogHtml;
        }

        // Lightweight overview-level maintenance display (optional)
        // Intentionally minimal to avoid blocking overview rendering.
        // If an element with id 'maintenance-overview' exists, populate it; otherwise no-op.
        function displayMaintenanceInfo(maintenance) {
            try {
                const el = document.getElementById('maintenance-overview');
                if (!el || !maintenance) return; // Safe no-op if overview element not present
                const mode = maintenance.maintenanceMode ? 'ENABLED' : 'Disabled';
                el.innerHTML = `
                    <div class="stat-row">
                        <span class="stat-label">Maintenance Mode</span>
                        <span class="stat-value ${maintenance.maintenanceMode ? 'maintenance-enabled' : 'maintenance-disabled'}">${mode}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Last Backup</span>
                        <span class="stat-value">${maintenance.lastBackup ? new Date(maintenance.lastBackup).toLocaleString() : 'Never'}</span>
                    </div>`;
            } catch (err) {
                console.warn('displayMaintenanceInfo error:', err);
            }
        }

        function displaySystemHealth(health) {
            // Defensive normalization: /api/health returns { status, checks, uptime, timestamp } (no issues/recommendations)
            // while richer maintenance/system health objects may include arrays. Avoid assuming presence.
            if(!health || typeof health !== 'object') {
                document.getElementById('system-health').innerHTML = '<div class="error-message">Health data unavailable</div>';
                return;
            }
            const normalized = {
                status: (health.status || 'unknown').toString(),
                issues: Array.isArray(health.issues) ? health.issues : [],
                recommendations: Array.isArray(health.recommendations) ? health.recommendations : [],
                uptime: typeof health.uptime === 'number' ? health.uptime : (typeof health.server?.uptime === 'number' ? health.server.uptime : undefined),
                checks: health.checks || {}
            };
            // Uptime regression styling escalation: if an issue contains 'Uptime regression' force critical indicator
            let statusOverride = normalized.status;
            if (normalized.issues.some(i => /uptime regression/i.test(i))) {
                statusOverride = 'critical';
            }

            // If stats are unavailable, force failure semantics for memory/errors checks.
            if (!statsAvailable) {
                // Ensure checks for memory & errors exist and are marked as failed
                if (normalized.checks) {
                    normalized.checks.memory = false;
                    normalized.checks.errors = false;
                } else {
                    normalized.checks = { memory: false, errors: false };
                }
                if (!normalized.issues.some(i => /statistics unavailable/i.test(i))) {
                    normalized.issues.push('Statistics unavailable');
                }
                // Only override to failed if not already critical (critical remains highest severity)
                if (statusOverride !== 'critical') {
                    statusOverride = 'failed';
                }
            }
            const statusClass = `status-${statusOverride}`;
            let html = `
                <div class="stat-row">
                    <span class="stat-label">Overall Status</span>
                    <span class="stat-value">
                        ${statusOverride.toUpperCase()}
                        <span class="${statusClass} status-indicator"></span>
                    </span>
                </div>
            `;

            // Show basic check breakdown if present
            try {
                const checkKeys = Object.keys(normalized.checks);
                if(checkKeys.length){
                    html += '<div style="margin-top:10px;"><strong>Checks:</strong><ul style="margin-left:20px; margin-top:5px;">' +
                        checkKeys.map(k => `<li style=\"color:${normalized.checks[k]?'#2ecc71':'#e74c3c'};\">${k}: ${normalized.checks[k]?'ok':'fail'}</li>`).join('') + '</ul></div>';
                }
            } catch { /* ignore */ }

            if (normalized.issues.length > 0) {
                html += `
                    <div style="margin-top: 15px;">
                        <strong>Issues:</strong>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            ${normalized.issues.map(issue => `<li style="color: #e74c3c;">${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (normalized.recommendations.length > 0) {
                html += `
                    <div style="margin-top: 15px;">
                        <strong>Recommendations:</strong>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            ${normalized.recommendations.map(rec => `<li style="color: #f39c12;">${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            document.getElementById('system-health').innerHTML = html;
        }

        async function loadSessions() {
            try {
                const response = await fetch('/api/admin/sessions');
                const data = await response.json();

                if (data.success) {
                    displaySessions(data.sessions);
                } else {
                    showError('Failed to load sessions');
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                showError('Failed to load sessions');
            }
        }

        // ===== Session History (NEW) =====
        async function loadSessionHistory(limit = 50) {
            try {
                const res = await fetch('/api/admin/sessions/history?limit=' + limit);
                const data = await res.json();
                if (!data.success) throw new Error();
                renderSessionHistory(data.history || []);
            } catch (err) {
                const el = document.getElementById('session-history-list');
                if (el) el.innerHTML = '<div class="error">Failed to load session history</div>';
            }
        }

        function renderSessionHistory(history) {
            const el = document.getElementById('session-history-list');
            if (!el) return;
            if (!history.length) { el.innerHTML = '<p>No history entries</p>'; return; }
            el.innerHTML = history.map(h => `
                <div class="session-item" style="background:#fff;">
                  <div class="session-header">
                    <span class="session-id" style="background:#ececec;">${h.id}</span>
                    <span style="font-size:11px; opacity:0.7;">${h.terminationReason || 'active'}</span>
                  </div>
                  <div class="stat-row"><span class="stat-label">Created</span><span class="stat-value">${new Date(h.createdAt).toLocaleString()}</span></div>
                  <div class="stat-row"><span class="stat-label">Ended</span><span class="stat-value">${h.endTime ? new Date(h.endTime).toLocaleString() : '‚Äî'}</span></div>
                </div>`).join('');
        }

        function refreshSessionHistory() {
            const limitSel = document.getElementById('session-history-limit');
            const limit = parseInt(limitSel.value, 10) || 50;
            loadSessionHistory(limit);
        }

        // ===== Synthetic Activity (NEW) =====
                async function runSyntheticActivity() {
            const iter = parseInt(document.getElementById('synthetic-iterations').value, 10) || 10;
            const conc = parseInt(document.getElementById('synthetic-concurrency').value, 10) || 2;
            const btn = document.getElementById('synthetic-run-btn');
            const output = document.getElementById('synthetic-output');
            btn.disabled = true; btn.textContent = 'Running‚Ä¶';
            output.textContent = 'Executing synthetic activity...';
            try {
                                const res = await fetch('/api/admin/synthetic/activity?debug=1', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ iterations: iter, concurrency: conc }) });
                                const rawText = await res.text();
                                let data = null;
                                try { data = JSON.parse(rawText); } catch { /* non-JSON */ }
                                if (!res.ok || !data) {
                                    throw new Error(data && (data.error || data.message) ? (data.error || data.message) : `HTTP ${res.status} (non-JSON)`);
                                }
                                if (!data.success) {
                                    throw new Error(data.error || data.message || 'Unknown failure');
                                }
                                const metaLine = `Executed ${data.executed}/${data.iterationsRequested} (errors:${data.errors}) in ${data.durationMs}ms @c=${data.concurrency} tools:${data.availableCount}`;
                                output.textContent = metaLine + (data.available ? `\nSample: ${data.available.slice(0,5).join(', ')}` : '');
                                const lastMeta = document.getElementById('synthetic-last-meta');
                                if (lastMeta) lastMeta.textContent = `Last run: ${new Date().toLocaleTimeString()} ${metaLine}`;
                // Optionally refresh overview stats & health after synthetic load
                loadOverviewData();
            } catch (err) {
                                const emsg = (err && err.message) || 'unknown error';
                                output.textContent = `Synthetic activity failed: ${emsg}`;
                                if (/No safe tools/i.test(emsg)) {
                                    output.textContent += '\nHint: Ensure server started after tool handlers registered (import order)';
                                }
            } finally {
                btn.disabled = false; btn.textContent = 'Run Synthetic Activity';
            }
        }

        function displaySessions(sessions) {
            if (sessions.length === 0) {
                document.getElementById('sessions-list').innerHTML = '<p>No active admin sessions</p>';
                return;
            }

            const html = sessions.map(session => `
                <div class="session-item">
                    <div class="session-header">
                        <span class="session-id">${session.id}</span>
                        <button class="action-btn danger" onclick="terminateSession('${session.id}')">Terminate</button>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">User ID</span>
                        <span class="stat-value">${session.userId}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">IP Address</span>
                        <span class="stat-value">${session.ipAddress}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Start Time</span>
                        <span class="stat-value">${new Date(session.startTime).toLocaleString()}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Last Activity</span>
                        <span class="stat-value">${new Date(session.lastActivity).toLocaleString()}</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('sessions-list').innerHTML = html;
        }

        async function createTestSession() {
            try {
                const response = await fetch('/api/admin/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: 'test_admin_' + Date.now() })
                });

                const data = await response.json();
                if (data.success) {
                    showSuccess('Test session created successfully');
                    loadSessions();
                } else {
                    showError('Failed to create test session');
                }
            } catch (error) {
                console.error('Error creating test session:', error);
                showError('Failed to create test session');
            }
        }

        async function terminateSession(sessionId) {
            try {
                const response = await fetch(`/api/admin/sessions/${sessionId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    showSuccess('Session terminated successfully');
                    loadSessions();
                } else {
                    showError('Failed to terminate session');
                }
            } catch (error) {
                console.error('Error terminating session:', error);
                showError('Failed to terminate session');
            }
        }

        async function loadMaintenanceStatus() {
            try {
                const response = await fetch('/api/admin/maintenance');
                const data = await response.json();

                if (data.success) {
                    displayMaintenanceStatus(data.maintenance);
                } else {
                    showError('Failed to load maintenance status');
                }
            } catch (error) {
                console.error('Error loading maintenance status:', error);
                showError('Failed to load maintenance status');
            }
        }

        function displayMaintenanceStatus(maintenance) {
            const statusClass = maintenance.maintenanceMode ? 'maintenance-enabled' : 'maintenance-disabled';
            const statusText = maintenance.maintenanceMode ? 'MAINTENANCE MODE ENABLED' : 'NORMAL OPERATION';
            
            let html = `
                <div class="maintenance-status ${statusClass}">
                    ${statusText}
                </div>
                <div class="stat-row">
                    <span class="stat-label">Last Backup</span>
                    <span class="stat-value">${maintenance.lastBackup ? new Date(maintenance.lastBackup).toLocaleString() : 'Never'}</span>
                </div>
            `;

            if (!maintenance.maintenanceMode) {
                html += `<button class="action-btn warning" onclick="toggleMaintenanceMode(true)">Enable Maintenance Mode</button>`;
            } else {
                html += `<button class="action-btn" onclick="toggleMaintenanceMode(false)">Disable Maintenance Mode</button>`;
            }

            document.getElementById('maintenance-control').innerHTML = html;
        }

        async function toggleMaintenanceMode(enable) {
            try {
                const response = await fetch('/api/admin/maintenance/mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        enabled: enable, 
                        message: enable ? 'Admin panel maintenance' : undefined 
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showSuccess(data.message);
                    loadMaintenanceStatus();
                } else {
                    showError('Failed to toggle maintenance mode');
                }
            } catch (error) {
                console.error('Error toggling maintenance mode:', error);
                showError('Failed to toggle maintenance mode');
            }
        }

        async function performBackup() {
            try {
                showSuccess('Backup started...');
                const response = await fetch('/api/admin/maintenance/backup', {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    showSuccess(`Backup completed: ${data.backupId}`);
                    loadMaintenanceStatus();
                } else {
                    showError('Backup failed');
                }
            } catch (error) {
                console.error('Error performing backup:', error);
                showError('Backup failed');
            }
        }

        async function clearCaches() {
            try {
                const response = await fetch('/api/admin/cache/clear', {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    showSuccess(`Caches cleared: ${data.cleared.join(', ')}`);
                } else {
                    showError('Failed to clear caches');
                }
            } catch (error) {
                console.error('Error clearing caches:', error);
                showError('Failed to clear caches');
            }
        }

        async function restartServer() {
            if (!confirm('Are you sure you want to restart the server? This may temporarily interrupt service.')) {
                return;
            }

            try {
                showSuccess('Server restart initiated...');
                const response = await fetch('/api/admin/restart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ component: 'all' })
                });

                const data = await response.json();
                if (data.success) {
                    showSuccess(data.message);
                } else {
                    showError('Server restart failed');
                }
            } catch (error) {
                console.error('Error restarting server:', error);
                showError('Server restart failed');
            }
        }

                async function loadConfiguration() {
                        try {
                                const res = await fetch('/api/admin/config');
                                const data = await res.json();
                                if (!data.success) throw new Error('Failed to load config');
                                const cfg = data.config;
                                const html = `
                                    <form onsubmit="return updateConfiguration(event)">
                                        <div class="form-group">
                                            <label class="form-label">Max Connections</label>
                                            <input class="form-input" type="number" id="cfg-maxConnections" value="${cfg.serverSettings.maxConnections}" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Request Timeout (ms)</label>
                                            <input class="form-input" type="number" id="cfg-requestTimeout" value="${cfg.serverSettings.requestTimeout}" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Verbose Logging</label>
                                            <select class="form-input" id="cfg-verbose"> <option value="1" ${cfg.serverSettings.enableVerboseLogging ? 'selected':''}>Enabled</option><option value="0" ${!cfg.serverSettings.enableVerboseLogging ? 'selected':''}>Disabled</option></select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Enable Mutation</label>
                                            <select class="form-input" id="cfg-mutation"> <option value="1" ${cfg.serverSettings.enableMutation ? 'selected':''}>Enabled</option><option value="0" ${!cfg.serverSettings.enableMutation ? 'selected':''}>Disabled</option></select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Rate Limit Window (ms)</label>
                                            <input class="form-input" type="number" id="cfg-windowMs" value="${cfg.serverSettings.rateLimit.windowMs}" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Rate Limit Max Requests</label>
                                            <input class="form-input" type="number" id="cfg-maxRequests" value="${cfg.serverSettings.rateLimit.maxRequests}" />
                                        </div>
                                        <div style="margin-top:10px;">
                                            <button class="action-btn" type="submit">üíæ Save Config</button>
                                        </div>
                                    </form>`;
                                document.getElementById('config-form').innerHTML = html;
                        } catch (e) {
                                document.getElementById('config-form').innerHTML = '<div class="error">Failed to load configuration</div>';
                        }
                }

                async function updateConfiguration(ev) {
                        ev.preventDefault();
                        const updates = {
                                serverSettings: {
                                        maxConnections: parseInt(document.getElementById('cfg-maxConnections').value),
                                        requestTimeout: parseInt(document.getElementById('cfg-requestTimeout').value),
                                        enableVerboseLogging: document.getElementById('cfg-verbose').value === '1',
                                        enableMutation: document.getElementById('cfg-mutation').value === '1',
                                        rateLimit: {
                                                windowMs: parseInt(document.getElementById('cfg-windowMs').value),
                                                maxRequests: parseInt(document.getElementById('cfg-maxRequests').value)
                                        }
                                }
                        };
                        try {
                                const res = await fetch('/api/admin/config', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(updates)});
                                const data = await res.json();
                                if (data.success) { showSuccess('Configuration updated'); loadConfiguration(); } else { showError(data.error || 'Update failed'); }
                        } catch (e) { showError('Update failed'); }
                        return false;
                }

        async function loadMonitoringData() {
            try {
                const [perfRes, sysRes, alertsRes] = await Promise.all([
                    fetch('/api/performance/detailed').catch(e=>e),
                    fetch('/api/system/health').catch(e=>e),
                    fetch('/api/alerts/active').catch(e=>e)
                ]);
                const [perfData, sysData, alertsData] = await Promise.all([
                    perfRes?.json ? perfRes.json().catch(()=>({})) : {},
                    sysRes?.json ? sysRes.json().catch(()=>({})) : {},
                    alertsRes?.json ? alertsRes.json().catch(()=>({})) : {}
                ]);
                const perf = perfData.data || {};
                const sys = sysData.data || {};
                const alerts = (alertsData.data || []).slice(0,5);
                const html = `
                  <div class="stat-row"><span class="stat-label">Throughput (rpm)</span><span class="stat-value">${perf.requestThroughput ?? '‚Äî'}</span></div>
                  <div class="stat-row"><span class="stat-label">Avg Response</span><span class="stat-value">${perf.averageResponseTime?.toFixed ? perf.averageResponseTime.toFixed(1)+'ms':'‚Äî'}</span></div>
                  <div class="stat-row"><span class="stat-label">P95</span><span class="stat-value">${perf.p95ResponseTime ?? '‚Äî'}ms</span></div>
                  <div class="stat-row"><span class="stat-label">Error Rate</span><span class="stat-value">${perf.errorRate?.toFixed ? perf.errorRate.toFixed(2)+'%':'‚Äî'}</span></div>
                  <div class="stat-row"><span class="stat-label">Active Connections</span><span class="stat-value">${perf.concurrentConnections ?? '‚Äî'}</span></div>
                  <div class="stat-row"><span class="stat-label">System Health</span><span class="stat-value">${sys.status || '‚Äî'}</span></div>
                  <div style="margin-top:10px;">
                    <strong>Active Alerts (${alerts.length})</strong>
                    <ul style="margin-left:20px;">${alerts.map(a=>`<li>${a.type} (${a.severity}) - ${a.message}</li>`).join('') || '<li>No active alerts</li>'}</ul>
                  </div>`;
                document.getElementById('monitoring-data').innerHTML = html;
            } catch (e) {
                document.getElementById('monitoring-data').innerHTML = '<div class="error">Failed to load monitoring data</div>';
            }
        }

        // ===== Instruction Management =====
        let instructionEditing = null;
                // Pagination state
                let allInstructions = [];
                let instructionPage = 1;
                let instructionPageSize = 25; // default page size

                function getInstructionPageSizes() { return [10,25,50,100, 'All']; }

                function buildInstructionPaginationControls(totalFiltered) {
                        const container = document.getElementById('instruction-pagination');
                        if (!container) return;
                        const total = totalFiltered;
                        const pageSize = instructionPageSize === 'All' ? total : instructionPageSize;
                        const totalPages = pageSize === 0 ? 1 : Math.max(1, Math.ceil(total / pageSize));
                        if (instructionPage > totalPages) instructionPage = totalPages; // clamp

                        const disablePrev = instructionPage <= 1;
                        const disableNext = instructionPage >= totalPages;

                        const sizeOptions = getInstructionPageSizes().map(s => `<option value="${s}" ${s===instructionPageSize? 'selected':''}>${s}</option>`).join('');
                        container.innerHTML = `
                            <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                <label style="display:flex; align-items:center; gap:4px;">Page Size:
                                    <select id="instruction-page-size" class="form-input" style="width:auto; padding:4px;">${sizeOptions}</select>
                                </label>
                                <div style="display:flex; align-items:center; gap:4px;">
                                    <button class="action-btn" onclick="changeInstructionPage('first')" ${disablePrev?'disabled':''}>‚èÆ First</button>
                                    <button class="action-btn" onclick="changeInstructionPage('prev')" ${disablePrev?'disabled':''}>‚óÄ Prev</button>
                                    <span style="font-size:12px;">Page ${instructionPage} / ${totalPages}</span>
                                    <button class="action-btn" onclick="changeInstructionPage('next')" ${disableNext?'disabled':''}>Next ‚ñ∂</button>
                                    <button class="action-btn" onclick="changeInstructionPage('last')" ${disableNext?'disabled':''}>Last ‚è≠</button>
                                </div>
                                <span style="margin-left:auto; font-size:12px; opacity:0.8;">Filtered: ${total} total</span>
                            </div>`;
                        const sizeSelect = document.getElementById('instruction-page-size');
                        sizeSelect.onchange = () => {
                                instructionPageSize = sizeSelect.value === 'All' ? 'All' : parseInt(sizeSelect.value,10);
                                instructionPage = 1; // reset to first page when size changes
                                renderInstructionList(allInstructions);
                        };
                }

                function changeInstructionPage(dir) {
                        const totalFiltered = getFilteredInstructions(allInstructions).length;
                        const pageSizeVal = instructionPageSize === 'All' ? totalFiltered : instructionPageSize;
                        const totalPages = pageSizeVal === 0 ? 1 : Math.max(1, Math.ceil(totalFiltered / pageSizeVal));
                        if (dir === 'first') instructionPage = 1;
                        else if (dir === 'prev' && instructionPage > 1) instructionPage--;
                        else if (dir === 'next' && instructionPage < totalPages) instructionPage++;
                        else if (dir === 'last') instructionPage = totalPages;
                        renderInstructionList(allInstructions);
                }

                function getFilteredInstructions(list) {
                        const filter = (document.getElementById('instruction-filter').value || '').toLowerCase();
                        return list.filter(i => i.name.toLowerCase().includes(filter));
                }

        async function loadInstructions() {
            const listEl = document.getElementById('instructions-list');
            listEl.innerHTML = 'Loading...';
            try {
                const res = await fetch('/api/instructions');
                const data = await res.json();
                if (!data.success) throw new Error();
                                allInstructions = data.instructions || [];
                                instructionPage = 1; // reset page whenever we reload
                                renderInstructionList(allInstructions);
            } catch (e) {
                listEl.innerHTML = '<div class="error">Failed to load instructions</div>';
            }
        }

        function renderInstructionList(instructions) {
                        const filtered = getFilteredInstructions(instructions);
            if (filtered.length === 0) {
                document.getElementById('instructions-list').innerHTML = '<p>No instructions found</p>';
                                buildInstructionPaginationControls(0);
                return;
            }
                        const totalFiltered = filtered.length;
                        let pageItems = filtered;
                        if (instructionPageSize !== 'All') {
                                const start = (instructionPage - 1) * instructionPageSize;
                                const end = start + instructionPageSize;
                                pageItems = filtered.slice(start, end);
                        }

                        const rows = pageItems.map(instr => `
                <div class="session-item" style="background:#fff;">
                    <div class="session-header">
                        <span class="session-id" style="background:#dfe6f1;">${instr.name}</span>
                        <div>
                           <button class="action-btn" onclick="editInstruction('${instr.name}')">‚úè Edit</button>
                           <button class="action-btn danger" onclick="deleteInstruction('${instr.name}')">üóë Delete</button>
                        </div>
                    </div>
                    <div class="stat-row"><span class="stat-label">Size</span><span class="stat-value">${instr.size} bytes</span></div>
                    <div class="stat-row"><span class="stat-label">Modified</span><span class="stat-value">${new Date(instr.mtime).toLocaleString()}</span></div>
                </div>`).join('');
            document.getElementById('instructions-list').innerHTML = rows;
                        buildInstructionPaginationControls(totalFiltered);
        }

        function filterInstructions() {
                        instructionPage = 1; // reset to first page on filter change
                        renderInstructionList(allInstructions);
        }

        function showCreateInstruction() {
            instructionEditing = null;
            document.getElementById('instruction-editor-title').textContent = 'New Instruction';
            document.getElementById('instruction-filename').value = '';
            document.getElementById('instruction-filename').disabled = false;
            document.getElementById('instruction-content').value = '{\n  "description": "New instruction"\n}';
            document.getElementById('instruction-editor').classList.remove('hidden');
            document.getElementById('instruction-filename').focus();
        }

        async function editInstruction(name) {
            try {
                const res = await fetch('/api/instructions/' + encodeURIComponent(name));
                const data = await res.json();
                if (!data.success) throw new Error();
                instructionEditing = name;
                document.getElementById('instruction-editor-title').textContent = 'Edit Instruction: ' + name;
                document.getElementById('instruction-filename').value = name;
                document.getElementById('instruction-filename').disabled = true;
                document.getElementById('instruction-content').value = JSON.stringify(data.content, null, 2);
                document.getElementById('instruction-editor').classList.remove('hidden');
            } catch (e) {
                showError('Failed to load instruction');
            }
        }

        function cancelEditInstruction() {
            document.getElementById('instruction-editor').classList.add('hidden');
        }

        async function saveInstruction() {
            const name = document.getElementById('instruction-filename').value.trim();
            if (!name) { showError('File name required'); return; }
            let content; 
            try { content = JSON.parse(document.getElementById('instruction-content').value); } catch { showError('Invalid JSON'); return; }
            const method = instructionEditing ? 'PUT' : 'POST';
            try {
                const res = await fetch('/api/instructions' + (instructionEditing ? '/' + encodeURIComponent(name) : ''), { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, content }) });
                const data = await res.json();
                if (data.success) { showSuccess('Instruction saved'); cancelEditInstruction(); loadInstructions(); } else { showError(data.error || 'Save failed'); }
            } catch { showError('Save failed'); }
        }

        async function deleteInstruction(name) {
            if (!confirm('Delete instruction ' + name + '?')) return;
            try {
                const res = await fetch('/api/instructions/' + encodeURIComponent(name), { method:'DELETE' });
                const data = await res.json();
                if (data.success) { showSuccess('Deleted'); loadInstructions(); } else { showError(data.error || 'Delete failed'); }
            } catch { showError('Delete failed'); }
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                if (currentSection === 'overview') {
                    loadOverviewData();
                } else if (currentSection === 'sessions') {
                    loadSessions();
                } else if (currentSection === 'maintenance') {
                    loadMaintenanceStatus();
                }
            }, 30000); // Refresh every 30 seconds
        }

        // Build metadata loader
        (async function fetchBuildMeta(){
            try {
                const r = await fetch('/api/status');
                const j = await r.json();
                const el = document.getElementById('buildMeta');
                const ver = j.version || '?.?.?';
                const commit = j.build ? `<span class=\"build-badge\">${j.build}</span>` : '';
                const bt = j.buildTime ? new Date(j.buildTime).toLocaleString() : 'unknown';
                el.innerHTML = `Version <strong>${ver}</strong> ${commit} ‚Ä¢ Built ${bt}`;
            } catch { const el = document.getElementById('buildMeta'); if(el) el.textContent='Build metadata unavailable'; }
        })();

        function showError(message) {
            // Remove existing notifications
            document.querySelectorAll('.error, .success').forEach(el => el.remove());
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.admin-container').insertBefore(errorDiv, document.querySelector('.admin-container').firstChild.nextSibling);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            // Remove existing notifications
            document.querySelectorAll('.error, .success').forEach(el => el.remove());
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.admin-container').insertBefore(successDiv, document.querySelector('.admin-container').firstChild.nextSibling);
            
            setTimeout(() => successDiv.remove(), 5000);
        }

        // Utility functions
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) return `${days}d ${hours}h ${minutes}m`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }

        function formatBytes(bytes) {
            const sizes = ['B', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</body>
</html>
